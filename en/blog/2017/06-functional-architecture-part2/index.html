---


---

<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<meta name=viewport content="width=device-width, initial-scale=1">
	<meta name="description" content="DevCrafting web site & blog, about all sort of things around software development">
	<meta name="author" content="Clément Bouillier">
	<meta rel="canonical" href="/en/blog/2017/06-functional-architecture-part2/" />
	<link rel="icon" type="image/png" href="/images/devCraftingFavIcon.png">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
		crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
	<link rel="stylesheet" href="/styles/custom.css" />
	<link rel="stylesheet" href="/styles/FSharpFormatting/style.css" />
	<title>Functional architecture and hexagonal architecture - Introducing Railway Oriented Programming - DevCrafting</title>

	 
</head>

<body>
	<div id="cookie-banner" style="display:none;">
		<div id="cookie-banner-message">
			Ce site utilise Google Analytics. En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure
			d'audience.
			<a href="javascript:tagAnalyticsCNIL.CookieConsent.showInform()">En savoir plus ou s'opposer</a>.
		</div>
	</div>
	<div id="inform-and-ask" style="display:none;">
		<div id="inform-and-consent">
			<div><b>Les cookies Google Analytics</b></div>
			<div>
                Ce site utilise des cookies de Google Analytics, ces cookies nous aident à identifier le contenu qui vous interesse le
				plus ainsi qu'à repérer certains dysfonctionnements. Vos données de navigations sur ce site sont envoyées à Google Inc.
            </div>
			<div>
                <button id="optout-button" name="optout" onclick="tagAnalyticsCNIL.CookieConsent.gaOptout();">S'opposer</button>
				<button name="cancel" onclick="tagAnalyticsCNIL.CookieConsent.hideInform()">Accepter</button>
            </div>
        </div>
        <div id="aknowledge-optout" style="display:none">
            Nous avons bien pris en compte votre souhait de ne pas envoyer vos données de navigation à Google Inc.<br/>
            <small>NB: ce message va s'effacer tout seul au bout de 5 secondes.</small>
        </div>
	</div>
	<header>
		<nav class="navbar navbar-devcrafting">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#dc-navbar-collapse" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
					<a class="navbar-brand" href="/en/">
						<img class="devcrafting-small-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkSmall.png" />
						<img class="devcrafting-big-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkTiny.png" />
					</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="dc-navbar-collapse">
					<ul class="nav navbar-nav">
						 
						<li><a href="/en/services/">Services</a></li>
						  
						<li><a href="/en/blog/">Blog</a></li>
						  
						<li><a href="/en/contact/">Contact</a></li>
						 
					</ul>
					<div class="navbar-right">
						<p class="social-links">
							<a class="fa fa-twitter" title="Twitter @clem_bouillier" href="https://twitter.com/clem_bouillier"></a>
							<a class="fa fa-github" title="GitHub @devcrafting" href="https://github.com/devcrafting"></a>
							<a class="fa fa-linkedin" title="Linked In" href="https://www.linkedin.com/in/clementbouillier"></a>
							<a class="fa fa-rss" title="RSS en" href="/en/rss.xml"></a>
						</p>
						
						<p class="lang-switcher">
							<span class="lang-mobile-only">Lang:</span> 
							<a href="/en/blog/2017/06-functional-architecture-part2/">EN</a> 
						</p>
						
					</div>
				</div>
			</div>
		</nav>
	</header>
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-9">
				
<article itemscope itemtype="http://schema.org/Article">
    <h1 itemprop="headline">Functional architecture and hexagonal architecture - Introducing Railway Oriented Programming</h1>
    <div class="row">
        <div class="col-sm-6 col-md-6" itemprop="keywords">
            <span class="fa fa-tags"></span>
            
                <a href="/en/tag/fsharp/" class="label label-default">fsharp</a>
            
                <a href="/en/tag/csharp/" class="label label-default">csharp</a>
            
                <a href="/en/tag/functional/" class="label label-default">functional</a>
            
                <a href="/en/tag/architecture/" class="label label-default">architecture</a>
            
            <span class="fa fa-comments"></span>
<a href="http://www.devcrafting.com/en/blog/2017/06-functional-architecture-part2/#disqus_thread">Leave a comment</a>

        </div>
        <div class="devcrafting-mobile-text-right col-sm-6 col-md-6">
            <!-- TODO: nb comments + link => Disqus -->
            <span class="fa fa-clock-o"></span>
            <time itemprop="datePublished" datetime="2017-06-07T00:00:00.0000000">
            Wednesday, June 7, 2017
            </time>
        </div>
    </div>
    <div class="devcrafting-article-body" itemprop="articleBody">
    <p>As a followup of the <a href="http://www.devcrafting.com/en/blog/2017/05-functional-architecture-part1/">previous post</a>, I would like to adjust the last example (using some comments' suggestions) and introduce a first basic F# implementation, which will allow to illustrate Railway Oriented Programming.</p>
<h2>Continuation implementation revisited</h2>
<p>As suggested in the comments of the previous post, the <a href="https://github.com/devcrafting/FunctionalArchitecture/blob/0a05b2255dd2e8cb9b10995886735a0c940147b8/HexagonalImpl/CartControllerContinuation.cs">continuation implementation would be even nicer with a more fluent interface</a> (you know, like Linq API). Then, the CartController implementation would be:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">public</span> <span class="k">class</span> CartControllerContinuation
{
    <span class="k">private</span> <span class="k">readonly</span> IProductStocks _productStocks;
    <span class="k">private</span> <span class="k">readonly</span> ICarts _carts;

    <span class="k">public</span> CartControllerContinuation(IProductStocks productStocks, ICarts carts)
    {
        _productStocks <span class="o">=</span> productStocks;
        _carts <span class="o">=</span> carts;
    }

    <span class="k">public</span> HttpResponseMessage AddProduct(AddProduct addProduct)
    {
        <span class="k">var</span> productStock <span class="o">=</span> _productStocks.Get(addProduct.ProductId);
        <span class="k">return</span> productStock
            .MakeATemporaryReservation_(addProduct.Quantity)
            .ContinueWith(temporaryReservation <span class="o">=</span><span class="o">&gt;</span>
                {
                    _productStocks.Save(productStock);
                    <span class="k">var</span> cart <span class="o">=</span> _carts.Get(addProduct.CartId);
                    <span class="k">return</span> cart.Add_(addProduct.ProductId, addProduct.Quantity, temporaryReservation);
                })
            .ContinueWith(cart <span class="o">=</span><span class="o">&gt;</span>
                {
                    _carts.Save(cart);
                    <span class="k">return</span> Either&lt;HttpResponseMessage, Error&gt;.Left(<span class="k">new</span> HttpResponseMessage(HttpStatusCode.Created));
                })
            .OnError(error <span class="o">=</span><span class="o">&gt;</span> <span class="k">new</span> HttpResponseMessage(HttpStatusCode.BadRequest))
            .Result();
    }
}
</code></pre></td></tr></table>
<p>We could improve readability using function instead of lambdas.</p>
<img alt="Railway oriented programming illustration" src="/images/railway-programming.jpg" class="img-float-right"/>
<p>To allow this fluent interface, I just modified the Either construct to return something instead of <code>void</code> for <code>ContinueWith</code> method. It returns a new Either with the same type for the second parameter. Depending on the result of the current Either, it continues with the one returned by the lambda given in parameter (the Left), else it switches to the Right. This switch mecanism can be viewed as a rail switch: you can continue "straight" (Left) OR you change to the other way (Right). For this reason, it is also known as <a href="https://fsharpforfunandprofit.com/rop/">Railway Oriented Programming</a> (you will find great illustration with railway switches schemas + a link to some code in F# and C# also). By the way, I forgot to mention that <code>Either</code> naming come from Haskell, it is a Monad (yes I said the M-word!). But I really like the metaphor with railway switches to explain that.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
<span class="l">50: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">public</span> <span class="k">class</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt;
{
    <span class="k">private</span> T<span class="n">1</span> _left;
    <span class="k">private</span> T<span class="n">2</span> _right;
    <span class="k">private</span> Func&lt;T<span class="n">2</span>, T<span class="n">1</span>&gt; _onError;

    <span class="k">private</span> Either(T<span class="n">1</span> t<span class="n">1</span>)
    {
        _left <span class="o">=</span> t<span class="n">1</span>;
    }

    <span class="k">private</span> Either(T<span class="n">2</span> t<span class="n">2</span>)
    {
        _right <span class="o">=</span> t<span class="n">2</span>;
    }

    <span class="k">public</span> <span class="k">static</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt; Left(T<span class="n">1</span> t<span class="n">1</span>)
    {
        <span class="k">return</span> <span class="k">new</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt;(t<span class="n">1</span>);
    }

    <span class="k">public</span> <span class="k">static</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt; Right(T<span class="n">2</span> t<span class="n">2</span>)
    {
        <span class="k">return</span> <span class="k">new</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt;(t<span class="n">2</span>);
    }

    <span class="k">public</span> Either&lt;T<span class="n">3</span>, T<span class="n">2</span>&gt; ContinueWith&lt;T<span class="n">3</span>&gt;(Func&lt;T<span class="n">1</span>, Either&lt;T<span class="n">3</span>, T<span class="n">2</span>&gt;<span class="o">&gt;</span> continueWith)
    {
        <span class="k">if</span> (_left <span class="o">!</span><span class="o">=</span> <span class="k">null</span>)
        {
            <span class="k">return</span> continueWith(_left);
        }
        <span class="k">return</span> Either&lt;T<span class="n">3</span>, T<span class="n">2</span>&gt;.Right(_right);
    }

    <span class="k">public</span> Either&lt;T<span class="n">1</span>, T<span class="n">2</span>&gt; OnError(Func&lt;T<span class="n">2</span>, T<span class="n">1</span>&gt; onError)
    {
        _onError <span class="o">=</span> onError;
        <span class="k">return</span> <span class="k">this</span>;
    }

    <span class="k">public</span> T<span class="n">1</span> Result()
    {
        <span class="k">if</span> (_left <span class="o">!</span><span class="o">=</span> <span class="k">null</span>)
        {
            <span class="k">return</span> _left;
        }
        <span class="k">return</span> _onError(_right);
    }
}
</code></pre></td></tr></table>
<p>My feelind is that Either is still quite (too much?!) verbose in object oriented language. Also, if you have a look at the (fake) implementation of Cart or ProductStock, you will see that it is also quite verbose to declare "go left" or "go right" as return value.</p>
<p>That's why, now, I propose you to switch to F# to see the magic happen :).</p>
<h2>A first basic F# implementation</h2>
<p>In this first F# implementation, I stick with the old continuation implementation shown at the end of the previous post (i.e without fluent interface), we will have something even nicer with F# in the next post.</p>
<p>The Either construct is called Result in this case:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="p">Success</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">a</span> | <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="p">Failure</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="t">string</span>
</code></pre></td>
</tr>
</table>
<p>Yes, it is just one line! That's part of the magic with F# :). We still have to implement the <code>ContinueWith</code> logic, but you will see it is not harder. I can even put the whole code here since it is so concise. It starts with the (immutable by default!) types I use:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">FunctionalArchitecture</span>

<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="i">System</span>

<span class="k">type</span> <span class="i">AddProduct</span> <span class="o">=</span> {
    <span class="i">CartId</span><span class="o">:</span> <span class="i">Guid</span>
    <span class="i">ProductId</span><span class="o">:</span> <span class="i">Guid</span>
    <span class="i">Quantity</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="i">int</span>
}

<span class="k">type</span> <span class="i">TemporaryReservation</span> <span class="o">=</span> {
    <span class="i">Id</span><span class="o">:</span> <span class="i">Guid</span>
}

<span class="k">type</span> <span class="i">ProductStock</span> <span class="o">=</span> {
    <span class="i">Id</span><span class="o">:</span> <span class="i">Guid</span>
    <span class="i">Quantity</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">int</span>
}

<span class="k">type</span> <span class="i">Cart</span> <span class="o">=</span> {
    <span class="i">Id</span><span class="o">:</span> <span class="i">Guid</span>
    <span class="i">Items</span><span class="o">:</span> <span class="i">CartItem</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">list</span>
}
<span class="k">and</span> <span class="i">CartItem</span> <span class="o">=</span> {
    <span class="i">ProductId</span><span class="o">:</span> <span class="i">Guid</span>
    <span class="i">Quantity</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 9)" onmouseover="showTip(event, 'fs6', 9)" class="i">int</span>
    <span class="i">Reservations</span><span class="o">:</span> <span class="i">TemporaryReservation</span> <span onmouseout="hideTip(event, 'fs7', 10)" onmouseover="showTip(event, 'fs7', 10)" class="i">list</span>
}

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs1', 11)" onmouseover="showTip(event, 'fs1', 11)" class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 12)" onmouseover="showTip(event, 'fs2', 12)" class="i">Success</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">a</span> | <span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">Failure</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 14)" onmouseover="showTip(event, 'fs4', 14)" class="i">string</span>
</code></pre></td>
</tr>
</table>
<p>Then I can declare the domain logic (equiv. of Cart and ProductStock classes)</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">makeATemporaryReservation</span> (<span class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) (<span class="i">productStock</span><span class="o">:</span><span class="i">ProductStock</span>) <span class="o">=</span> 
    <span class="k">let</span> <span class="i">remainingQuantity</span> <span class="o">=</span> <span class="i">productStock</span><span class="o">.</span><span class="i">Quantity</span> <span class="o">-</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">Quantity</span>
    <span class="k">if</span> <span class="i">remainingQuantity</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">0</span> <span class="k">then</span>
        <span onmouseout="hideTip(event, 'fs2', 15)" onmouseover="showTip(event, 'fs2', 15)" class="i">Success</span> ({ <span class="i">TemporaryReservation</span><span class="o">.</span><span class="i">Id</span> <span class="o">=</span> <span class="i">Guid</span><span class="o">.</span><span class="i">NewGuid</span>() }, { <span class="i">productStock</span> <span class="k">with</span> <span class="i">Quantity</span> <span class="o">=</span> <span class="i">remainingQuantity</span> })
    <span class="k">else</span>
        <span onmouseout="hideTip(event, 'fs8', 16)" onmouseover="showTip(event, 'fs8', 16)" class="i">Failure</span> <span class="s">&quot;Not enough stock&quot;</span>

<span class="k">let</span> <span class="i">addProductToCart</span> (<span class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) (<span class="i">temporaryReservation</span><span class="o">:</span><span class="i">TemporaryReservation</span>) (<span class="i">cart</span><span class="o">:</span><span class="i">Cart</span>) <span class="o">=</span>
    <span class="c">// Nothing is modified here (immutable by default)</span>
    <span class="k">let</span> <span class="i">cartItems</span>, <span class="i">cartItem</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="i">cart</span><span class="o">.</span><span class="i">Items</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 17)" onmouseover="showTip(event, 'fs9', 17)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 18)" onmouseover="showTip(event, 'fs10', 18)" class="i">tryFind</span> (<span class="k">fun</span> <span class="i">i</span> <span class="k">-&gt;</span> <span class="i">i</span><span class="o">.</span><span class="i">ProductId</span> <span class="o">=</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>) <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs11', 19)" onmouseover="showTip(event, 'fs11', 19)" class="i">Some</span> <span class="i">item</span> <span class="k">-&gt;</span> 
            <span class="i">cart</span><span class="o">.</span><span class="i">Items</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 20)" onmouseover="showTip(event, 'fs9', 20)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs12', 21)" onmouseover="showTip(event, 'fs12', 21)" class="i">except</span> [<span class="i">item</span>], 
            { <span class="i">item</span> <span class="k">with</span> <span class="i">Quantity</span> <span class="o">=</span> <span class="i">item</span><span class="o">.</span><span class="i">Quantity</span> <span class="o">+</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">Quantity</span>; <span class="i">Reservations</span> <span class="o">=</span> <span class="i">temporaryReservation</span> <span class="o">::</span> <span class="i">item</span><span class="o">.</span><span class="i">Reservations</span> }
        | <span onmouseout="hideTip(event, 'fs13', 22)" onmouseover="showTip(event, 'fs13', 22)" class="i">None</span> <span class="k">-&gt;</span> 
            <span class="i">cart</span><span class="o">.</span><span class="i">Items</span>, 
            { <span class="i">ProductId</span> <span class="o">=</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">Quantity</span>; <span class="i">Reservations</span> <span class="o">=</span> [ <span class="i">temporaryReservation</span> ] }
    <span class="k">if</span> <span class="i">cartItem</span><span class="o">.</span><span class="i">Quantity</span> <span class="o">&gt;</span> <span class="n">99</span> <span class="k">then</span>
        <span onmouseout="hideTip(event, 'fs8', 23)" onmouseover="showTip(event, 'fs8', 23)" class="i">Failure</span> <span class="s">&quot;Too many items of same product&quot;</span>
    <span class="c">// ... many other rules on cart content</span>
    <span class="k">else</span>
        <span onmouseout="hideTip(event, 'fs2', 24)" onmouseover="showTip(event, 'fs2', 24)" class="i">Success</span> { <span class="i">cart</span> <span class="k">with</span> <span class="i">Items</span> <span class="o">=</span> <span class="i">cartItem</span> <span class="o">::</span> <span class="i">cartItems</span> }
</code></pre></td>
</tr>
</table>
<p>Then I have some fake implementations of infrastructure (equiv. of ICarts and IProductStocks implementation):</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">getProductStock</span> <span onmouseout="hideTip(event, 'fs14', 25)" onmouseover="showTip(event, 'fs14', 25)" class="i">id</span> <span class="o">=</span> 
    <span class="c">// Some data access...</span>
    { <span class="i">Id</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs14', 26)" onmouseover="showTip(event, 'fs14', 26)" class="i">id</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="n">10</span> }

<span class="k">let</span> <span class="i">saveProductStock</span> <span class="i">productStock</span> <span class="o">=</span> 
    <span class="c">// Some data access...</span>
    ()

<span class="k">let</span> <span class="i">getCart</span> <span onmouseout="hideTip(event, 'fs14', 27)" onmouseover="showTip(event, 'fs14', 27)" class="i">id</span> <span class="o">=</span>
    <span class="c">// Some data access...</span>
    { <span class="i">Id</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs14', 28)" onmouseover="showTip(event, 'fs14', 28)" class="i">id</span>; <span class="i">Items</span> <span class="o">=</span> [] }

<span class="k">let</span> <span class="i">saveCart</span> <span class="i">cart</span> <span class="o">=</span>
    <span class="c">// Some data access...</span>
    ()
</code></pre></td>
</tr>
</table>
<p>And in the end, the controller orchestrates the whole:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 29)" onmouseover="showTip(event, 'fs5', 29)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 30)" onmouseover="showTip(event, 'fs15', 30)" class="i">Net</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 31)" onmouseover="showTip(event, 'fs5', 31)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 32)" onmouseover="showTip(event, 'fs15', 32)" class="i">Net</span><span class="o">.</span><span class="i">Http</span>

<span class="k">let</span> <span class="i">addProductToCartController</span> (<span class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) <span class="o">=</span>
    <span class="i">getProductStock</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>
    <span class="o">|&gt;</span> <span class="i">makeATemporaryReservation</span> <span class="i">addProduct</span>
    <span class="o">|&gt;</span> <span class="k">function</span> 
        | <span onmouseout="hideTip(event, 'fs2', 33)" onmouseover="showTip(event, 'fs2', 33)" class="i">Success</span> (<span class="i">tempReservation</span>, <span class="i">productStock</span>) <span class="k">-&gt;</span> 
            <span class="i">saveProductStock</span> <span class="i">productStock</span>
            <span class="i">getCart</span> <span class="i">addProduct</span><span class="o">.</span><span class="i">CartId</span>
            <span class="o">|&gt;</span> <span class="i">addProductToCart</span> <span class="i">addProduct</span> <span class="i">tempReservation</span>
            <span class="o">|&gt;</span> <span class="k">function</span>
                | <span onmouseout="hideTip(event, 'fs2', 34)" onmouseover="showTip(event, 'fs2', 34)" class="i">Success</span> <span class="i">cart</span> <span class="k">-&gt;</span> 
                    <span class="i">saveCart</span> <span class="i">cart</span>
                    <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">OK</span>)
                | <span onmouseout="hideTip(event, 'fs8', 35)" onmouseover="showTip(event, 'fs8', 35)" class="i">Failure</span> <span class="i">message</span> <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">BadRequest</span>)
        | <span onmouseout="hideTip(event, 'fs8', 36)" onmouseover="showTip(event, 'fs8', 36)" class="i">Failure</span> <span class="i">message</span> <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">BadRequest</span>)
</code></pre></td>
</tr>
</table>
<p>The <a href="https://github.com/devcrafting/FunctionalArchitecture/blob/0a05b2255dd2e8cb9b10995886735a0c940147b8/FunctionalImpl/CartController.fs">full source code is here</a>.</p>
<p>Some cool things to note:</p>
<ul>
<li>I do not hide anything from you, the whole F# code is there. <strong>It is far less verbose, without being cryptic IMHO</strong>. If you are not used to F#, it could be a little cryptic, but I highly encourage you to learn functional languages, I feel it is much easier than the whole OOP languages, patterns and practices. <a href="https://fsharpforfunandprofit.com/posts/conciseness-intro/">Scott Wlaschin explains more in depth the conciseness power</a>.</li>
<li>F# forces you to layer things in the order they are used, so <strong>it enforces dependencies' direction of an onion/hexagonal architecture</strong>: first bits of code are the core, last bits are the infrastracture and the shell of the application.</li>
<li>I did not use any injection in the domain functions, on the opposite of what we are used to in OOP (like in CartService and ProductStockService in the previous post). It was already there in the previous OOP continuation implementation. Orchestration of infrastructure call (with side-effects) and domain logic is done in the shell. <strong>Both approches are hexagonal/onion architecture, but only the one without injection is pure functional architecture, i.e functional core (domain without side-effects = inner layer of the onion), imperative shell (side-effects + glue the whole = outer layer of the onion)</strong>.</li>
<li>And last, can you see the pattern with <code>function | Success ... | Failure ...</code> (using a <a href="http://www.markhneedham.com/blog/2010/02/07/f-function-keyword/">shortened syntax of a pattern matching</a>)? It will help us for the next post :).</li>
</ul>
<h2>Next step</h2>
<p>From this first F# implementation, we <a href="http://www.devcrafting.com/en/blog/2017/08-functional-architecture-part3/">will be able to evolve towards an even nicer implementation</a>, removing the pattern we just spotted. It will explain by example what is a Monad. And I will also show you how to use Computation Expression in F# to have a final version I really like.</p>


<div class="tip" id="fs1">type Result&lt;&#39;a&gt; =<br />&#160;&#160;| Success of &#39;a<br />&#160;&#160;| Failure of string<br /><br />Full name: functionalarchitecturepart.Result&lt;_&gt;</div>
<div class="tip" id="fs2">union case Result.Success: &#39;a -&gt; Result&lt;&#39;a&gt;</div>
<div class="tip" id="fs3">Multiple items<br />union case Result.Failure: string -&gt; Result&lt;&#39;a&gt;<br /><br />--------------------<br />active recognizer Failure: exn -&gt; string option<br /><br />Full name: Microsoft.FSharp.Core.Operators.( |Failure|_| )</div>
<div class="tip" id="fs4">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs5">namespace System</div>
<div class="tip" id="fs6">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs7">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs8">union case Result.Failure: string -&gt; Result&lt;&#39;a&gt;</div>
<div class="tip" id="fs9">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs10">val tryFind : predicate:(&#39;T -&gt; bool) -&gt; list:&#39;T list -&gt; &#39;T option<br /><br />Full name: Microsoft.FSharp.Collections.List.tryFind</div>
<div class="tip" id="fs11">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs12">val except : itemsToExclude:seq&lt;&#39;T&gt; -&gt; list:&#39;T list -&gt; &#39;T list (requires equality)<br /><br />Full name: Microsoft.FSharp.Collections.List.except</div>
<div class="tip" id="fs13">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs14">val id : x:&#39;T -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.id</div>
<div class="tip" id="fs15">namespace System.Net</div>

    </div>
    <!-- DISQUS integration -->
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
    this.page.url = 'http://www.devcrafting.com/en/blog/2017/06-functional-architecture-part2/';
    //this.page.identifier = PAGE_IDENTIFIER; 
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//devcrafting-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
<script id="dsq-count-scr" src="//devcrafting-1.disqus.com/count.js" async></script>


			</div>
			<div class="col-sm-3">
				<p>
					<a class="twitter-timeline" data-theme="dark" data-link-color="#FAB81E" height="500" href="https://twitter.com/clem_bouillier">Tweets de Clément Bouillier</a>
				</p>
			</div>
		</div>
	</div>
	<footer>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-6">
					<h4>Contact &amp; about</h4>
					<p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a> and <a href="http://dotliquidmarkup.org/">DotLiquid</a>. It was mostly inspired by <a href="http://tomasp.net">tomasp.net</a>,
						created by <a href="https://github.com/tpetricek">Tomas Petricek</a>, with some F# code copied from <a href="https://github.com/tpetricek/tomasp.net">his site source code</a>.
						For more info, see the <a href="https://github.com/devcrafting/devcrafting.github.io">website source on GitHub</a>.
					</p>
					<p>Please submit <a href="https://github.com/devcrafting/devcrafting.github.io/issues">issues &amp; corrections on GitHub</a>. Use <a href="https://github.com/devcrafting/devcrafting.github.io/pulls">pull requests</a> for minor corrections only.</p>
					<ul>
						<li><i class="fa fa-twitter"></i> Twitter: <a href="http://twitter.com/clem_bouillier">@clem_bouillier</a></li>
						<li><i class="fa fa-github"></i> GitHub: <a href="https://github.com/devcrafting">@devcrafting</a></li>
						<li><i class="fa fa-envelope"></i> Email: <a href="mailto:clement.bouillier@devcrafting.com">clement.bouillier@devcrafting.com</a></li>
					</ul>
				</div>
				<div class="col-sm-6">
					<h4>License</h4>
					<p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>.
						All source code samples are licensed under Apache 2.0.
					</p>
					<p style="text-align:center;margin-top:15px;"><img src="/images/cc-by-sa.png" alt="CC BY SA License logo" /></p>
					<h4>Privacy</h4>
					<a href="javascript:tagAnalyticsCNIL.CookieConsent.gaOptout()">Click here</a> to suppress audience measure tool from
					Google.
				</div>
			</div>
		</div>
	</footer>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<script src="/scripts/main.js"></script>
	<script src="/scripts/cookies.js"></script>
	<script>
        tagAnalyticsCNIL.CookieConsent = tagAnalyticsCNIL.CookieConsentBuilder('UA-52462933-1');
        tagAnalyticsCNIL.CookieConsent.start();
    </script>
	<script id="dsq-count-scr" src="//devcrafting-1.disqus.com/count.js" async></script>

</body>

</html>