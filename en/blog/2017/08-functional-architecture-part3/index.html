---


---

<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<meta name=viewport content="width=device-width, initial-scale=1">
	<meta name="description" content="DevCrafting web site & blog, about all sort of things around software development">
	<meta name="author" content="Clément Bouillier">
	<meta rel="canonical" href="/en/blog/2017/08-functional-architecture-part3/" />
	<link rel="icon" type="image/png" href="/images/devCraftingFavIcon.png">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
		crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
	<link rel="stylesheet" href="/styles/custom.css" />
	<link rel="stylesheet" href="/styles/FSharpFormatting/style.css" />
	<title>Functional architecture and hexagonal architecture - Introducing bind, Monad and Continuation Expressions - DevCrafting</title>

	 
</head>

<body>
	<div id="cookie-banner" style="display:none;">
		<div id="cookie-banner-message">
			Ce site utilise Google Analytics. En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure
			d'audience.
			<a href="javascript:tagAnalyticsCNIL.CookieConsent.showInform()">En savoir plus ou s'opposer</a>.
		</div>
	</div>
	<div id="inform-and-ask" style="display:none;">
		<div id="inform-and-consent">
			<div><b>Les cookies Google Analytics</b></div>
			<div>
                Ce site utilise des cookies de Google Analytics, ces cookies nous aident à identifier le contenu qui vous interesse le
				plus ainsi qu'à repérer certains dysfonctionnements. Vos données de navigations sur ce site sont envoyées à Google Inc.
            </div>
			<div>
                <button id="optout-button" name="optout" onclick="tagAnalyticsCNIL.CookieConsent.gaOptout();">S'opposer</button>
				<button name="cancel" onclick="tagAnalyticsCNIL.CookieConsent.hideInform()">Accepter</button>
            </div>
        </div>
        <div id="aknowledge-optout" style="display:none">
            Nous avons bien pris en compte votre souhait de ne pas envoyer vos données de navigation à Google Inc.<br/>
            <small>NB: ce message va s'effacer tout seul au bout de 5 secondes.</small>
        </div>
	</div>
	<header>
		<nav class="navbar navbar-devcrafting">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#dc-navbar-collapse" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
					<a class="navbar-brand" href="/en/">
						<img class="devcrafting-small-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkSmall.png" />
						<img class="devcrafting-big-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkTiny.png" />
					</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="dc-navbar-collapse">
					<ul class="nav navbar-nav">
						 
						<li><a href="/en/services/">Services</a></li>
						  
						<li><a href="/en/blog/">Blog</a></li>
						  
						<li><a href="/en/contact/">Contact</a></li>
						 
					</ul>
					<div class="navbar-right">
						<p class="social-links">
							<a class="fa fa-twitter" title="Twitter @clem_bouillier" href="https://twitter.com/clem_bouillier"></a>
							<a class="fa fa-github" title="GitHub @devcrafting" href="https://github.com/devcrafting"></a>
							<a class="fa fa-linkedin" title="Linked In" href="https://www.linkedin.com/in/clementbouillier"></a>
							<a class="fa fa-rss" title="RSS en" href="/en/rss.xml"></a>
						</p>
						
						<p class="lang-switcher">
							<span class="lang-mobile-only">Lang:</span> 
							<a href="/en/blog/2017/08-functional-architecture-part3/">EN</a> 
						</p>
						
					</div>
				</div>
			</div>
		</nav>
	</header>
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-9">
				
<article itemscope itemtype="http://schema.org/Article">
    <h1 itemprop="headline">Functional architecture and hexagonal architecture - Introducing bind, Monad and Continuation Expressions</h1>
    <div class="row">
        <div class="col-sm-6 col-md-6" itemprop="keywords">
            <span class="fa fa-tags"></span>
            
                <a href="/en/tag/fsharp/" class="label label-default">fsharp</a>
            
                <a href="/en/tag/functional/" class="label label-default">functional</a>
            
                <a href="/en/tag/architecture/" class="label label-default">architecture</a>
            
            <span class="fa fa-comments"></span>
<a href="http://www.devcrafting.com/en/blog/2017/08-functional-architecture-part3/#disqus_thread">Leave a comment</a>

        </div>
        <div class="devcrafting-mobile-text-right col-sm-6 col-md-6">
            <!-- TODO: nb comments + link => Disqus -->
            <span class="fa fa-clock-o"></span>
            <time itemprop="datePublished" datetime="2017-08-23T00:00:00.0000000">
            Wednesday, August 23, 2017
            </time>
        </div>
    </div>
    <div class="devcrafting-article-body" itemprop="articleBody">
    <p>In the <a href="http://www.devcrafting.com/en/blog/2017/06-functional-architecture-part2/">previous post</a>, I started a first F# implementation, showing "beauty" of F# code ;). Now it is time to improve a bit the controller function to be more fluent.</p>
<h2>Introduce the <code>bind</code> function</h2>
<p>As spotted in the previous post, we could do something with the recurring pattern around Success/Failure pattern matching in the following code:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="f">addProductToCartController</span> (<span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) <span class="o">=</span>
    <span class="i">getProductStock</span> <span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>
    <span class="o">|&gt;</span> <span class="i">makeATemporaryReservation</span> <span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="i">addProduct</span>
    <span class="o">|&gt;</span> <span class="k">function</span> 
        | <span class="i">Success</span> (<span class="i">tempReservation</span>, <span class="i">productStock</span>) <span class="k">-&gt;</span> 
            <span class="i">saveProductStock</span> <span class="i">productStock</span>
            <span class="i">getCart</span> <span onmouseout="hideTip(event, 'fs2', 5)" onmouseover="showTip(event, 'fs2', 5)" class="i">addProduct</span><span class="o">.</span><span class="i">CartId</span>
            <span class="o">|&gt;</span> <span class="i">addProductToCart</span> <span onmouseout="hideTip(event, 'fs2', 6)" onmouseover="showTip(event, 'fs2', 6)" class="i">addProduct</span> <span class="i">tempReservation</span>
            <span class="o">|&gt;</span> <span class="k">function</span>
                | <span class="i">Success</span> <span class="i">cart</span> <span class="k">-&gt;</span> 
                    <span class="i">saveCart</span> <span class="i">cart</span>
                    <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">OK</span>)
                | <span onmouseout="hideTip(event, 'fs3', 7)" onmouseover="showTip(event, 'fs3', 7)" class="i">Failure</span> <span class="i">message</span> <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">BadRequest</span>)
        | <span onmouseout="hideTip(event, 'fs3', 8)" onmouseover="showTip(event, 'fs3', 8)" class="i">Failure</span> <span class="i">message</span> <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">BadRequest</span>)
</code></pre></td>
</tr>
</table>
<p>We could define a function with two parameters</p>
<ul>
<li>the function to call in case of Success on the embedded value</li>
<li>the previous Result (Success or Failure)</li>
</ul>
<p>It returns a new Result (Success or Failure).</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 9)" onmouseover="showTip(event, 'fs4', 9)" class="f">bind</span> <span onmouseout="hideTip(event, 'fs5', 10)" onmouseover="showTip(event, 'fs5', 10)" class="i">func</span> <span onmouseout="hideTip(event, 'fs6', 11)" onmouseover="showTip(event, 'fs6', 11)" class="i">result</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs6', 12)" onmouseover="showTip(event, 'fs6', 12)" class="i">result</span> <span class="k">with</span>
    | <span class="i">Success</span> <span class="i">p</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 13)" onmouseover="showTip(event, 'fs5', 13)" class="i">func</span> <span class="i">p</span>
    | <span onmouseout="hideTip(event, 'fs3', 14)" onmouseover="showTip(event, 'fs3', 14)" class="i">Failure</span> <span class="i">m</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs3', 15)" onmouseover="showTip(event, 'fs3', 15)" class="i">Failure</span> <span class="i">m</span>
</code></pre></td>
</tr>
</table>
<p>With this function, we can rewrite the <code>addProductToCartController</code>:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 16)" onmouseover="showTip(event, 'fs1', 16)" class="f">addProductToCartController</span> (<span onmouseout="hideTip(event, 'fs2', 17)" onmouseover="showTip(event, 'fs2', 17)" class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) <span class="o">=</span>
    <span class="i">getProductStock</span> <span onmouseout="hideTip(event, 'fs2', 18)" onmouseover="showTip(event, 'fs2', 18)" class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>
    <span class="o">|&gt;</span> <span class="i">makeATemporaryReservation</span> <span onmouseout="hideTip(event, 'fs2', 19)" onmouseover="showTip(event, 'fs2', 19)" class="i">addProduct</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 20)" onmouseover="showTip(event, 'fs4', 20)" class="f">bind</span> (<span class="k">fun</span> (<span onmouseout="hideTip(event, 'fs7', 21)" onmouseover="showTip(event, 'fs7', 21)" class="i">tempReservation</span>, <span onmouseout="hideTip(event, 'fs8', 22)" onmouseover="showTip(event, 'fs8', 22)" class="i">productStock</span>) <span class="k">-&gt;</span> 
        <span class="i">saveProductStock</span> <span onmouseout="hideTip(event, 'fs8', 23)" onmouseover="showTip(event, 'fs8', 23)" class="i">productStock</span>
        <span class="i">getCart</span> <span onmouseout="hideTip(event, 'fs2', 24)" onmouseover="showTip(event, 'fs2', 24)" class="i">addProduct</span><span class="o">.</span><span class="i">CartId</span>
        <span class="o">|&gt;</span> <span class="i">addProductToCart</span> <span onmouseout="hideTip(event, 'fs2', 25)" onmouseover="showTip(event, 'fs2', 25)" class="i">addProduct</span> <span onmouseout="hideTip(event, 'fs7', 26)" onmouseover="showTip(event, 'fs7', 26)" class="i">tempReservation</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 27)" onmouseover="showTip(event, 'fs4', 27)" class="f">bind</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs9', 28)" onmouseover="showTip(event, 'fs9', 28)" class="i">cart</span> <span class="k">-&gt;</span> 
            <span class="i">saveCart</span> <span onmouseout="hideTip(event, 'fs9', 29)" onmouseover="showTip(event, 'fs9', 29)" class="i">cart</span>
            <span class="i">Success</span> ()))
    <span class="o">|&gt;</span> <span class="i">toHttpResponse</span>
</code></pre></td>
</tr>
</table>
<p>It reduces the indentation, but it not really more readable for now. Note <code>toHttpResponse</code> function pushes at the end the decision of transforming the last Result to an HttpResponseMessage, that's quite nice. For example:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs10', 30)" onmouseover="showTip(event, 'fs10', 30)" class="f">toHttpResponse</span> <span onmouseout="hideTip(event, 'fs11', 31)" onmouseover="showTip(event, 'fs11', 31)" class="i">result</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs11', 32)" onmouseover="showTip(event, 'fs11', 32)" class="i">result</span> <span class="k">with</span>
    | <span class="i">Success</span> _ <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">OK</span>)
    | <span onmouseout="hideTip(event, 'fs3', 33)" onmouseover="showTip(event, 'fs3', 33)" class="i">Failure</span> _ <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">HttpResponseMessage</span>(<span class="i">HttpStatusCode</span><span class="o">.</span><span class="i">BadRequest</span>)
</code></pre></td>
</tr>
</table>
<p>There is still this weird <code>bind</code> call in the middle of our code. In functional language, we like custom operators, but in fact they are quite "standard"...and there is one for <code>bind</code>: <code>&gt;&gt;=</code>. So let's define it in F#:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> (<span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span>) <span onmouseout="hideTip(event, 'fs12', 34)" onmouseover="showTip(event, 'fs12', 34)" class="f">f1</span> <span onmouseout="hideTip(event, 'fs13', 35)" onmouseover="showTip(event, 'fs13', 35)" class="i">f2</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 36)" onmouseover="showTip(event, 'fs12', 36)" class="f">f1</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs4', 37)" onmouseover="showTip(event, 'fs4', 37)" class="f">bind</span> <span onmouseout="hideTip(event, 'fs13', 38)" onmouseover="showTip(event, 'fs13', 38)" class="i">f2</span>
</code></pre></td>
</tr>
</table>
<p>A bit confusing? It uses composition (&gt;&gt;), let's explain step by step:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// When you have this:</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 39)" onmouseover="showTip(event, 'fs14', 39)" class="f">someFunction</span> <span onmouseout="hideTip(event, 'fs15', 40)" onmouseover="showTip(event, 'fs15', 40)" class="i">x</span> <span class="o">=</span>
    <span class="i">f1</span> <span onmouseout="hideTip(event, 'fs15', 41)" onmouseover="showTip(event, 'fs15', 41)" class="i">x</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 42)" onmouseover="showTip(event, 'fs4', 42)" class="f">bind</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs16', 43)" onmouseover="showTip(event, 'fs16', 43)" class="i">y</span> <span class="k">-&gt;</span> <span class="i">f2</span> <span onmouseout="hideTip(event, 'fs16', 44)" onmouseover="showTip(event, 'fs16', 44)" class="i">y</span>)

<span class="c">// You can rewrite it:</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 45)" onmouseover="showTip(event, 'fs14', 45)" class="f">someFunction</span> <span onmouseout="hideTip(event, 'fs15', 46)" onmouseover="showTip(event, 'fs15', 46)" class="i">x</span> <span class="o">=</span>
    <span class="i">f1</span> <span onmouseout="hideTip(event, 'fs15', 47)" onmouseover="showTip(event, 'fs15', 47)" class="i">x</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 48)" onmouseover="showTip(event, 'fs4', 48)" class="f">bind</span> <span class="i">f2</span>

<span class="c">// Or:</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 49)" onmouseover="showTip(event, 'fs14', 49)" class="f">someFunction</span> <span onmouseout="hideTip(event, 'fs15', 50)" onmouseover="showTip(event, 'fs15', 50)" class="i">x</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs4', 51)" onmouseover="showTip(event, 'fs4', 51)" class="f">bind</span> <span class="i">f2</span> (<span class="i">f1</span> <span onmouseout="hideTip(event, 'fs15', 52)" onmouseover="showTip(event, 'fs15', 52)" class="i">x</span>)

<span class="c">// And it is equivalent to composition of &quot;f1&quot; with &quot;bind f2&quot;</span>
<span class="c">// Remember maths: f(g(x)) is the same as &quot;f composed with g&quot; applied to x (f.g(x))</span>
<span class="c">// In F#, you write f.g with g &gt;&gt; f (it is like apply g then f), so:</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs17', 53)" onmouseover="showTip(event, 'fs17', 53)" class="f">someFunction</span> <span class="o">=</span> <span class="i">f1</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs4', 54)" onmouseover="showTip(event, 'fs4', 54)" class="f">bind</span> <span class="i">f2</span>
</code></pre></td>
</tr>
</table>
<p>Then, our controller can be rewritten:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 55)" onmouseover="showTip(event, 'fs1', 55)" class="f">addProductToCartController</span> (<span onmouseout="hideTip(event, 'fs2', 56)" onmouseover="showTip(event, 'fs2', 56)" class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) <span class="o">=</span>
<span class="i">getProductStock</span> <span onmouseout="hideTip(event, 'fs2', 57)" onmouseover="showTip(event, 'fs2', 57)" class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>
<span class="o">|&gt;</span> (<span class="i">makeATemporaryReservation</span> <span onmouseout="hideTip(event, 'fs2', 58)" onmouseover="showTip(event, 'fs2', 58)" class="i">addProduct</span>
    <span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span> (<span class="k">fun</span> (<span onmouseout="hideTip(event, 'fs7', 59)" onmouseover="showTip(event, 'fs7', 59)" class="i">tempReservation</span>, <span onmouseout="hideTip(event, 'fs8', 60)" onmouseover="showTip(event, 'fs8', 60)" class="i">productStock</span>) <span class="k">-&gt;</span> 
        <span class="i">saveProductStock</span> <span onmouseout="hideTip(event, 'fs8', 61)" onmouseover="showTip(event, 'fs8', 61)" class="i">productStock</span>
        <span class="i">getCart</span> <span onmouseout="hideTip(event, 'fs2', 62)" onmouseover="showTip(event, 'fs2', 62)" class="i">addProduct</span><span class="o">.</span><span class="i">CartId</span>
        <span class="o">|&gt;</span> (<span class="i">addProductToCart</span> <span onmouseout="hideTip(event, 'fs2', 63)" onmouseover="showTip(event, 'fs2', 63)" class="i">addProduct</span> <span onmouseout="hideTip(event, 'fs7', 64)" onmouseover="showTip(event, 'fs7', 64)" class="i">tempReservation</span>
            <span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs9', 65)" onmouseover="showTip(event, 'fs9', 65)" class="i">cart</span> <span class="k">-&gt;</span> 
                <span class="i">saveCart</span> <span onmouseout="hideTip(event, 'fs9', 66)" onmouseover="showTip(event, 'fs9', 66)" class="i">cart</span>
                <span class="i">Success</span> ()))))
<span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs10', 67)" onmouseover="showTip(event, 'fs10', 67)" class="f">toHttpResponse</span>
</code></pre></td>
</tr>
</table>
<p>It removes the bind word, but it requires more brackets :/ (and for some readers it adds cryptic/not usual functional operators...).</p>
<h2>Introduce Monad by example</h2>
<p>So let's try to talk a bit of theory around Monad from this example (please tell me if I make mistakes in my explanation, I am far from an expert).</p>
<p>The <code>bind</code> function transforms a "world-crossing function" between a "normal world" and an "elevated world" (<a href="https://fsharpforfunandprofit.com/posts/elevated-world/#series-toc">see Scott Wlaschin explanation</a>) into a function that manipulate only "elevated world" values. For example, it can transform a function with singature <code>a -&gt; Result&lt;b&gt;</code>, into a function with signature <code>Result&lt;a&gt; -&gt; Result&lt;b&gt;</code>.</p>
<p>If we have a look at our controller, we want to chain several functions depending on the previous function Result. Each function uses the "normal world" value embedded in case of Success by the previous one, that's why we need this <code>bind</code> function.</p>
<p>Chaining operations is in fact the goal of a Monad. To define a Monad, we need a data type (<code>Result&lt;a&gt;</code> for example), 2 functions <code>bind</code> and <code>return</code> (which is just a function that allows to elevate a "normal world" value, i.e <code>a -&gt; Result&lt;a&gt;</code> for example), and some properties that must be enforced (not covered here). That's why <code>bind</code> is also called a <strong>monadic function</strong>.</p>
<h2>Use Computation Expressions in F#</h2>
<p>I think it is enough for Monad theory for now :). Let's switch to F# computation expression feature, which allows to simplify our controller, removing the need for bind or "esoteric" functional operator.</p>
<p>F# computation expression lets you define your own F# construct in the following form (async and seq constructs are built this way):</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs18', 68)" onmouseover="showTip(event, 'fs18', 68)" class="i">myCustomConstruct</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs18', 69)" onmouseover="showTip(event, 'fs18', 69)" class="i">myCustomConstruct</span> {
    [<span class="o">..</span><span class="o">.</span><span class="i">statements</span><span class="o">..</span><span class="o">.</span>]
}
</code></pre></td>
</tr>
</table>
<p>Inside this construct, you can use several keywords like <code>return</code> or <code>let!</code> (said "let bang"). To use them, you must define a builder for your construct with some specific functions, and instantiate it. <code>let!</code> is defined implementing the <code>Bind</code> function, and <code>return</code> is defined with the <code>Return</code> function. Sounds good, no? So let's define and instantiate a <code>result</code> computation expression using our previous <code>bind</code> function:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">ResultBuilder</span>() <span class="o">=</span>
    <span class="k">member</span> <span class="i">this</span><span class="o">.</span><span class="i">Bind</span>(<span class="i">m</span>, <span class="i">f</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 70)" onmouseover="showTip(event, 'fs4', 70)" class="i">bind</span> <span class="i">f</span> <span class="i">m</span>
    <span class="k">member</span> <span class="i">this</span><span class="o">.</span><span class="i">Return</span>(<span class="i">x</span>) <span class="o">=</span> <span class="i">Success</span> <span class="i">x</span>

<span class="k">let</span> <span class="i">result</span> <span class="o">=</span> <span class="k">new</span> <span class="i">ResultBuilder</span>()
</code></pre></td>
</tr>
</table>
<p>And now we can use it to declare our controller:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 71)" onmouseover="showTip(event, 'fs1', 71)" class="i">addProductToCartController</span> (<span onmouseout="hideTip(event, 'fs2', 72)" onmouseover="showTip(event, 'fs2', 72)" class="i">addProduct</span><span class="o">:</span><span class="i">AddProduct</span>) <span class="o">=</span>
    <span class="i">result</span> {
        <span class="k">let!</span> (<span class="i">tempReservation</span>, <span class="i">productStock</span>) <span class="o">=</span> 
            <span class="i">getProductStock</span> <span onmouseout="hideTip(event, 'fs2', 73)" onmouseover="showTip(event, 'fs2', 73)" class="i">addProduct</span><span class="o">.</span><span class="i">ProductId</span>
            <span class="o">|&gt;</span> <span class="i">makeATemporaryReservation</span> <span onmouseout="hideTip(event, 'fs2', 74)" onmouseover="showTip(event, 'fs2', 74)" class="i">addProduct</span>
        <span class="i">saveProductStock</span> <span class="i">productStock</span>
        <span class="k">let!</span> <span class="i">cart</span> <span class="o">=</span> 
            <span class="i">getCart</span> <span onmouseout="hideTip(event, 'fs2', 75)" onmouseover="showTip(event, 'fs2', 75)" class="i">addProduct</span><span class="o">.</span><span class="i">CartId</span>
            <span class="o">|&gt;</span> <span class="i">addProductToCart</span> <span onmouseout="hideTip(event, 'fs2', 76)" onmouseover="showTip(event, 'fs2', 76)" class="i">addProduct</span> <span class="i">tempReservation</span>
        <span class="k">return</span> <span class="i">saveCart</span> <span class="i">cart</span>
    }
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs10', 77)" onmouseover="showTip(event, 'fs10', 77)" class="f">toHttpResponse</span>
</code></pre></td>
</tr>
</table>
<p><code>let!</code> calls the <code>bind</code> function, switching to the end on Failure, ignoring the rest like exception does, but without any exception.
I find it far more readable! And you?</p>
<h2>Want to learn more?</h2>
<p>I have just shown one use case of the bind function and F# computation expressions. I encourage you to have a look to <a href="https://fsharpforfunandprofit.com/posts/elevated-world/#series-toc">this very detailed series written by Scott Wlaschin</a>, and in particular, there are more examples in <a href="https://fsharpforfunandprofit.com/posts/elevated-world-3/">this one comparing applicative and monadic styles for validation</a>.</p>


<div class="tip" id="fs1">val addProductToCartController : addProduct:&#39;a -&gt; &#39;b<br /><br />Full name: functionalarchitecturepart.addProductToCartController</div>
<div class="tip" id="fs2">val addProduct : &#39;a</div>
<div class="tip" id="fs3">Multiple items<br />val Failure : message:string -&gt; exn<br /><br />Full name: Microsoft.FSharp.Core.Operators.Failure<br /><br />--------------------<br />active recognizer Failure: exn -&gt; string option<br /><br />Full name: Microsoft.FSharp.Core.Operators.( |Failure|_| )</div>
<div class="tip" id="fs4">val bind : func:&#39;a -&gt; result:&#39;b -&gt; &#39;c<br /><br />Full name: functionalarchitecturepart.bind</div>
<div class="tip" id="fs5">val func : &#39;a</div>
<div class="tip" id="fs6">val result : &#39;b</div>
<div class="tip" id="fs7">val tempReservation : obj</div>
<div class="tip" id="fs8">val productStock : obj</div>
<div class="tip" id="fs9">val cart : obj</div>
<div class="tip" id="fs10">val toHttpResponse : result:&#39;a -&gt; &#39;b<br /><br />Full name: functionalarchitecturepart.toHttpResponse</div>
<div class="tip" id="fs11">val result : &#39;a</div>
<div class="tip" id="fs12">val f1 : (&#39;a -&gt; &#39;b)</div>
<div class="tip" id="fs13">val f2 : &#39;c</div>
<div class="tip" id="fs14">val someFunction : x:&#39;a -&gt; &#39;b<br /><br />Full name: functionalarchitecturepart.someFunction</div>
<div class="tip" id="fs15">val x : &#39;a</div>
<div class="tip" id="fs16">val y : obj</div>
<div class="tip" id="fs17">val someFunction : (obj -&gt; obj)<br /><br />Full name: functionalarchitecturepart.someFunction</div>
<div class="tip" id="fs18">val myCustomConstruct : obj</div>

    </div>
    <!-- DISQUS integration -->
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
    this.page.url = 'http://www.devcrafting.com/en/blog/2017/08-functional-architecture-part3/';
    //this.page.identifier = PAGE_IDENTIFIER; 
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//devcrafting-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
<script id="dsq-count-scr" src="//devcrafting-1.disqus.com/count.js" async></script>


			</div>
			<div class="col-sm-3">
				<p>
					<a class="twitter-timeline" data-theme="dark" data-link-color="#FAB81E" height="500" href="https://twitter.com/clem_bouillier">Tweets de Clément Bouillier</a>
				</p>
			</div>
		</div>
	</div>
	<footer>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-6">
					<h4>Contact &amp; about</h4>
					<p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a> and <a href="http://dotliquidmarkup.org/">DotLiquid</a>. It was mostly inspired by <a href="http://tomasp.net">tomasp.net</a>,
						created by <a href="https://github.com/tpetricek">Tomas Petricek</a>, with some F# code copied from <a href="https://github.com/tpetricek/tomasp.net">his site source code</a>.
						For more info, see the <a href="https://github.com/devcrafting/devcrafting.github.io">website source on GitHub</a>.
					</p>
					<p>Please submit <a href="https://github.com/devcrafting/devcrafting.github.io/issues">issues &amp; corrections on GitHub</a>. Use <a href="https://github.com/devcrafting/devcrafting.github.io/pulls">pull requests</a> for minor corrections only.</p>
					<ul>
						<li><i class="fa fa-twitter"></i> Twitter: <a href="http://twitter.com/clem_bouillier">@clem_bouillier</a></li>
						<li><i class="fa fa-github"></i> GitHub: <a href="https://github.com/devcrafting">@devcrafting</a></li>
						<li><i class="fa fa-envelope"></i> Email: <a href="mailto:clement.bouillier@devcrafting.com">clement.bouillier@devcrafting.com</a></li>
					</ul>
				</div>
				<div class="col-sm-6">
					<h4>License</h4>
					<p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>.
						All source code samples are licensed under Apache 2.0.
					</p>
					<p style="text-align:center;margin-top:15px;"><img src="/images/cc-by-sa.png" alt="CC BY SA License logo" /></p>
					<h4>Privacy</h4>
					<a href="javascript:tagAnalyticsCNIL.CookieConsent.gaOptout()">Click here</a> to suppress audience measure tool from
					Google.
				</div>
			</div>
		</div>
	</footer>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<script src="/scripts/main.js"></script>
	<script src="/scripts/cookies.js"></script>
	<script>
        tagAnalyticsCNIL.CookieConsent = tagAnalyticsCNIL.CookieConsentBuilder('UA-52462933-1');
        tagAnalyticsCNIL.CookieConsent.start();
    </script>
	<script id="dsq-count-scr" src="//devcrafting-1.disqus.com/count.js" async></script>

</body>

</html>