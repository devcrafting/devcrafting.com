---


---

<!DOCTYPE html>
<html lang="fr">

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<meta name=viewport content="width=device-width, initial-scale=1">
	<meta name="description" content="DevCrafting web site & blog, about all sort of things around software development">
	<meta name="author" content="Clément Bouillier">
	<meta rel="canonical" href="/fr/blog/2017/02-refactoring-de-code-legacy-part-3-god-class-et-autres-techniques/" />
	<link rel="icon" type="image/png" href="/images/devCraftingFavIcon.png">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
		crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
	<link rel="stylesheet" href="/styles/custom.css" />
	<link rel="stylesheet" href="/styles/FSharpFormatting/style.css" />
	<title>Refactoring de code legacy : "God class" et quelques autres techniques - DevCrafting</title>

	 
</head>

<body>
	<div id="cookie-banner" style="display:none;">
		<div id="cookie-banner-message">
			Ce site utilise Google Analytics. En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure
			d'audience.
			<a href="javascript:tagAnalyticsCNIL.CookieConsent.showInform()">En savoir plus ou s'opposer</a>.
		</div>
	</div>
	<div id="inform-and-ask" style="display:none;">
		<div id="inform-and-consent">
			<div><b>Les cookies Google Analytics</b></div>
			<div>
                Ce site utilise des cookies de Google Analytics, ces cookies nous aident à identifier le contenu qui vous interesse le
				plus ainsi qu'à repérer certains dysfonctionnements. Vos données de navigations sur ce site sont envoyées à Google Inc.
            </div>
			<div>
                <button id="optout-button" name="optout" onclick="tagAnalyticsCNIL.CookieConsent.gaOptout();">S'opposer</button>
				<button name="cancel" onclick="tagAnalyticsCNIL.CookieConsent.hideInform()">Accepter</button>
            </div>
        </div>
        <div id="aknowledge-optout" style="display:none">
            Nous avons bien pris en compte votre souhait de ne pas envoyer vos données de navigation à Google Inc.<br/>
            <small>NB: ce message va s'effacer tout seul au bout de 5 secondes.</small>
        </div>
	</div>
	<header>
		<nav class="navbar navbar-devcrafting">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#dc-navbar-collapse" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
					<a class="navbar-brand" href="/fr/">
						<img class="devcrafting-small-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkSmall.png" />
						<img class="devcrafting-big-logo" alt="DevCrafting" src="/images/devCraftingLogoDarkTiny.png" />
					</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="dc-navbar-collapse">
					<ul class="nav navbar-nav">
						 
						<li><a href="/fr/services/">Services</a></li>
						  
						<li><a href="/fr/blog/">Blog</a></li>
						  
						<li><a href="/fr/contact/">Contact</a></li>
						  
						<li><a href="/fr/a-propos/">A propos</a></li>
						 
					</ul>
					<div class="navbar-right">
						<p class="social-links">
							<a class="fa fa-twitter" title="Twitter @clem_bouillier" href="https://twitter.com/clem_bouillier"></a>
							<a class="fa fa-github" title="GitHub @devcrafting" href="https://github.com/devcrafting"></a>
							<a class="fa fa-linkedin" title="Linked In" href="https://www.linkedin.com/in/clementbouillier"></a>
							<a class="fa fa-rss" title="RSS fr" href="/fr/rss.xml"></a>
						</p>
						
						<p class="lang-switcher">
							<span class="lang-mobile-only">Lang:</span> 
							<a href="/fr/blog/2017/02-refactoring-de-code-legacy-part-3-god-class-et-autres-techniques/">FR</a> 
						</p>
						
					</div>
				</div>
			</div>
		</nav>
	</header>
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-9">
				
<article itemscope itemtype="http://schema.org/Article">
    <h1 itemprop="headline">Refactoring de code legacy : "God class" et quelques autres techniques</h1>
    <div class="row">
        <div class="col-sm-6 col-md-6" itemprop="keywords">
            <span class="fa fa-tags"></span>
            
                <a href="/fr/tag/refactoring/" class="label label-default">refactoring</a>
            
                <a href="/fr/tag/software craftsmanship/" class="label label-default">software craftsmanship</a>
            
            <span class="fa fa-comments"></span>
<a href="http://www.devcrafting.com/fr/blog/2017/02-refactoring-de-code-legacy-part-3-god-class-et-autres-techniques/#disqus_thread">Laisser un commentaire</a>

        </div>
        <div class="devcrafting-mobile-text-right col-sm-6 col-md-6">
            <!-- TODO: nb comments + link => Disqus -->
            <span class="fa fa-clock-o"></span>
            <time itemprop="datePublished" datetime="2017-02-15T00:00:00.0000000">
            mercredi 15 février 2017
            </time>
        </div>
    </div>
    <div class="devcrafting-article-body" itemprop="articleBody">
    <p>Voici la suite du <a href="/fr/blog/2017/01-refactoring-de-code-legacy-part-2-isoler-les-dependances/">billet sur l'isolation des dépendances dans le cadre d'un refactoring de code legacy</a>. Ces billets font suite à une journée d'atelier avec <a href="https://twitter.com/mfeathers">Mickael Feathers</a>, l'auteur de <a href="http://wiki.c2.com/?WorkingEffectivelyWithLegacyCode">Working effectively with legacy code</a>.</p>
<p>Dans les deux premiers billets, nous avons vu comment écrire des tests de caractérisation et isoler les dépendances. Dans ce billet, nous allons voir quelques techniques de refactoring.</p>
<h2>Refactoring d'une "God class"</h2>
<img alt="Illustration d'une God class" class="img-float-left" src="/images/god.jpg" />
<p>Une "God class" c'est une classe qui fait beaucoup trop de choses, qui a donc trop de responsabilités. C'est assez facile à reconnaître : la taille de la classe suffit généralement à caractériser une "God class". Je ne veux pas forcément donner de seuil arbitraire sur une métrique arbitraire, mais à partir de 200 à 300 lignes de code, ou 10 à 15 méthodes, ou 5 à 10 propriétés (privées ou publiques via getter/setter)...bref vous voyez l'idée.</p>
<h3>S'attaquer à une "God class"</h3>
<p>Alors comment s'y prendre ? On se sent souvent démuni face à ce genre de classe, c'est d'ailleurs loin d'être simple !</p>
<p>On peut vérifier si certains membres semblent avoir été groupés dans la classe, avec des commentaires par exemple (ou des #region en C#). Cela indique souvent la présence de choses liées qu'on peut tenter d'isoler. Malheureusement, ce n'est pas toujours aussi simple, dans ce cas, il faut étudier un peu plus le code. Pour ce genre de refactoring, il est généralement nécessaire de faire quelques essais à blanc, c'est-à-dire qu'on tente un refactoring, puis on recommence à zéro au besoin.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">public</span> <span class="k">class</span> Product
{
  <span class="c">// Fields about pricing</span>
  <span class="k">public</span> <span class="k">decimal</span> PriceExcludingTax { get; set; }
  <span class="k">public</span> <span class="k">decimal</span> VatRate { get; set; }

  <span class="c">// Fields about product description</span>
  <span class="k">public</span> <span class="k">string</span> Name { get; set; }
  <span class="k">public</span> <span class="k">string</span> Description { get; set; }
  <span class="k">public</span> <span class="k">string</span> Manufacturer { get; set; } 
  <span class="k">public</span> List&lt;<span class="k">string</span>&gt; Comments { get; set; } 

  <span class="k">public</span> <span class="k">decimal</span> GetPriceIncludingTax() { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
  <span class="k">public</span> <span class="k">void</span> ChangePrice(<span class="k">decimal</span> priceExcludingTax, <span class="k">decimal</span> vatRate) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }

  <span class="k">public</span> <span class="k">void</span> ChangeProductDescription(<span class="k">string</span> name, <span class="k">string</span> description, <span class="k">string</span> manufacturer) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
  <span class="k">public</span> <span class="k">void</span> AddComment(<span class="k">string</span> comment) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
}
</code></pre></td></tr></table>
<p>Le refactoring consiste à créer une nouvelle classe ("Extract Class"), pour laquelle on prendra le temps de bien la nommer. On peut ensuite extraire des méthodes ("Extract Method") vers cette nouvelle classe tout en gardant l'interface publique de la classe d'origine.</p>
<p>Cela peut être facilité par des outils intégrés à l'IDE, c'est plus simple et plus sûr (moins de chances de faire une erreur de manipulation). Si vous n'avez pas ce genre d'outils, ce n'est pas forcément compliqué à faire manuellement non plus, c'est principalement du copier-coller. Il y a d'ailleurs des cas où ce sera plus adapté de le faire manuellement pour éviter un "big bang" trop important, c'est-à-dire changer trop de code d'un coup.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">public</span> <span class="k">class</span> Product
{
  <span class="k">public</span> ProductPricing ProductPricing { get; set; }

  <span class="c">// Fields about product description</span>
  <span class="k">public</span> <span class="k">string</span> Name { get; set; }
  <span class="k">public</span> <span class="k">string</span> Description { get; set; }
  <span class="k">public</span> <span class="k">string</span> Manufacturer { get; set; } 
  <span class="k">public</span> List&lt;<span class="k">string</span>&gt; Comments { get; set; } 

  <span class="k">public</span> <span class="k">decimal</span> GetPriceIncludingTax() { <span class="k">return</span> ProductPricing.GetPriceIncludingTax(); }
  <span class="k">public</span> <span class="k">void</span> ChangePrice(<span class="k">decimal</span> priceExcludingTax, <span class="k">decimal</span> vatRate)
  {
    ProductPricing.ChangePrice(priceExcludingTax, vatRate);
  }

  <span class="k">public</span> <span class="k">void</span> ChangeProductDescription(<span class="k">string</span> name, <span class="k">string</span> description, <span class="k">string</span> manufacturer) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
  <span class="k">public</span> <span class="k">void</span> AddComment(<span class="k">string</span> comment) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
}

<span class="k">public</span> <span class="k">class</span> ProductPricing
{
  <span class="c">// Fields about pricing</span>
  <span class="k">public</span> <span class="k">decimal</span> PriceExcludingTax { get; set; }
  <span class="k">public</span> <span class="k">decimal</span> VatRate { get; set; }

  <span class="k">public</span> <span class="k">decimal</span> GetPriceIncludingTax() { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
  <span class="k">public</span> <span class="k">void</span> ChangePrice(<span class="k">decimal</span> priceExcludingTax, <span class="k">decimal</span> vatRate) { <span class="o">.</span><span class="o">.</span><span class="o">.</span> }
}
</code></pre></td></tr></table>
<p>Dans cet exemple, on aurait par exemple pu commencer par extraire la classe ProductPricing en commençant par les propriétés uniquement, puis extraire les méthodes une à une. A noter que cela peut mener à rompre l'encapsulation, l'idée est de le faire temporairement pour faciliter la démarche de refactoring. L'exemple pris n'illustre pas ce point car le code manque cruellement d'encapsulation (getter/setter publics systématiques), c'est un raccourci intentionnel, à ne pas reproduire évidemment, mais je laisse ce sujet pour plus tard.</p>
<p>Autre note pour aller plus loin, dans l'exemple donné, on voit deux responsabilités distinctes : la description du produit et son pricing. Il est très courant de voir une conception autour de l'objet Product visant à modéliser la réalité, or ce genre d'abstraction trop proche de la réalité est souvent une fausse bonne idée. J'interprête cela comme un travers provenant d'exemples simplistes pour expliquer la programmation objet et notamment de l'héritage (du type Chien et Chat sont des Animaux...). Plutôt que modéliser un état des concepts issus du monde réel (Product), essayer de modéliser la dynamique/les usages de ces concepts dans les différents contextes d'utilisation, cela fait émerger des concepts plus précis (ProductPricing, ProductDescription) avec une inter-dépendance souvent très faible (ici l'id du produit).</p>
<h3>Utiliser une "God class"</h3>
<p>Lorsque vous devez faire appel à une "God class" ou l'utiliser en paramètre, pour clarifier l'intention que vous aviez en l'utilisant, il est préférable d'utiliser une interface extraite ("Extract Interface").</p>
<p>Dans un code existant, on peut également utiliser cette technique pour clarifier les dépendances à cette "God class". Pour cela, commencer par extraire une interface vide, remplacer l'utilisation de la "God class" par l'interface, on a alors des erreurs de compilation qui vous guideront pour savoir quelles méthodes ajouter. Enfin, on renomme l'interface pour clarifier l'intention de son utilisation.</p>
<h2>Quelques autres techniques de refactoring</h2>
<h3>Faites germer vos fonctionnalités</h3>
<img alt="Illustration du fait de faire germer vos fonctionnalités par une jeune pousse de plante" class="img-float-left" src="/images/sprout.jpg"/>
<p>Quand on ajoute une fonctionnalité dans un code legacy, on a tendance à s'insérer dans l'existant, en mode "Edit and Pray". Mais alors quand est-ce qu'on améliore le code ?</p>
<p>Face à un code legacy, pour éviter de continuer à écrire du code "à l'ancienne", on peut utiliser la technique "Sprout method/class", c'est-à-dire littéralement "faire germer une méthode/une classe". L'idée est d'écrire</p>
<h3>Enlever le "code qui pue"</h3>
<img alt="Illustration du fait d'enlever les Code Smells par le nettoyage d'une plage après une marée noire" class="img-float-left" src="/images/removeCodeSmells.jpg"/>
<p><a href="https://twitter.com/martinfowler">Martin Fowler</a> dans son livre <a href="https://martinfowler.com/books/refactoring.html">Refactoring</a> liste un grand nombre de "Code Smells", avec des refactorings associés. Un exemple type de "Code Smell" est la suppression des "switch" qui révèlent souvent un polymorphisme non implémenté. Pour corriger cela, c'est assez simple, il suffit d'extraire une méthode dans une classe, puis d'ajouter successivement les classes dérivées représentant chaque cas du "switch".</p>
<h3>Utiliser des "variables tests"</h3>
<img alt="Illustration des variables tests par un multimètre" class="img-float-left" src="/images/multimeter.jpg"/>
<p>Pour les tests, ne vous limitez pas à écrire du code "beau", parfois il est préférable de passer par des étapes intermédiaires "non idéales". Notamment, on peut utiliser des variables tests ("sensing variables") qui vont permettre de mieux comprendre le comportement d'une classe/méthode ou de le tester plus facilement, on les enlèvera une fois le refactoring terminé.</p>
<h2>La suite...</h2>
<p>Nous voici à la fin de cette série de billets sur le refactoring. Il y a évidemment beaucoup plus à dire, mais le plus important est de pratiquer pour s'améliorer. La suite c'est donc vous qui allez l'écrire...via du code, lors de Coding Dojo par exemple :).</p>
<p>Je reviendrais probablement sur certaines pratiques de refactoring. Un point qui m'intéresse particulièrement en ce moment est le refactoring de code legacy fonctionnel...à suivre.</p>



    </div>
    <!-- DISQUS integration -->
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
    this.page.url = 'http://www.devcrafting.com/fr/blog/2017/02-refactoring-de-code-legacy-part-3-god-class-et-autres-techniques/';
    //this.page.identifier = PAGE_IDENTIFIER; 
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//devcrafting-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
<script id="dsq-count-scr" src="//devcrafting-2.disqus.com/count.js" async></script>


			</div>
			<div class="col-sm-3">
				<p>
					<a class="twitter-timeline" data-theme="dark" data-link-color="#FAB81E" height="500" href="https://twitter.com/clem_bouillier">Tweets de Clément Bouillier</a>
				</p>
			</div>
		</div>
	</div>
	<footer>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-6">
					<h4>Contact &amp; about</h4>
					<p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a> and <a href="http://dotliquidmarkup.org/">DotLiquid</a>. It was mostly inspired by <a href="http://tomasp.net">tomasp.net</a>,
						created by <a href="https://github.com/tpetricek">Tomas Petricek</a>, with some F# code copied from <a href="https://github.com/tpetricek/tomasp.net">his site source code</a>.
						For more info, see the <a href="https://github.com/devcrafting/devcrafting.github.io">website source on GitHub</a>.
					</p>
					<p>Please submit <a href="https://github.com/devcrafting/devcrafting.github.io/issues">issues &amp; corrections on GitHub</a>. Use <a href="https://github.com/devcrafting/devcrafting.github.io/pulls">pull requests</a> for minor corrections only.</p>
					<ul>
						<li><i class="fa fa-twitter"></i> Twitter: <a href="http://twitter.com/clem_bouillier">@clem_bouillier</a></li>
						<li><i class="fa fa-github"></i> GitHub: <a href="https://github.com/devcrafting">@devcrafting</a></li>
						<li><i class="fa fa-envelope"></i> Email: <a href="mailto:clement.bouillier@devcrafting.com">clement.bouillier@devcrafting.com</a></li>
					</ul>
				</div>
				<div class="col-sm-6">
					<h4>License</h4>
					<p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>.
						All source code samples are licensed under Apache 2.0.
					</p>
					<p style="text-align:center;margin-top:15px;"><img src="/images/cc-by-sa.png" alt="CC BY SA License logo" /></p>
					<h4>Privacy</h4>
					<a href="javascript:tagAnalyticsCNIL.CookieConsent.gaOptout()">Click here</a> to suppress audience measure tool from
					Google.
				</div>
			</div>
		</div>
	</footer>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<script src="/scripts/main.js"></script>
	<script src="/scripts/cookies.js"></script>
	<script>
        tagAnalyticsCNIL.CookieConsent = tagAnalyticsCNIL.CookieConsentBuilder('UA-52462933-1');
        tagAnalyticsCNIL.CookieConsent.start();
    </script>
	<script id="dsq-count-scr" src="//devcrafting-2.disqus.com/count.js" async></script>

</body>

</html>